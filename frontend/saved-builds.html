<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ - CSX</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .tabs {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 1px solid #555;
        }
        
        .tab {
            padding: 1rem 2rem;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        
        .tab.active {
            background: #4cc9f0;
            color: #1a1a1a;
            border-color: #555;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .builds-grid, .comparisons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }
        
        .build-card, .comparison-card {
            background: linear-gradient(145deg, #4a4a4a, #3a3a3a);
            border: 1px solid #4cc9f0;
            border-radius: 8px;
            padding: 1.5rem;
            position: relative;
        }
        
        .card-actions {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
        }
        
        .action-btn {
            background: none;
            border: none;
            color: #e0e0e0;
            cursor: pointer;
            padding: 0.3rem;
            border-radius: 3px;
            transition: background 0.3s;
        }
        
        .action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #888;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .stat-card {
            background: rgba(76, 201, 240, 0.1);
            border: 1px solid #4cc9f0;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            color: #4cc9f0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üíæ –ú–æ–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h1>
            <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∞—à–∏–º–∏ —Å–±–æ—Ä–∫–∞–º–∏ –∏ —Ä–∞—Å—á–µ—Ç–∞–º–∏</p>
        </header>

        <div class="artifacts-container">
            <a href="index.html" class="back-button">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('builds')">–ú–æ–∏ —Å–±–æ—Ä–∫–∏</div>
                <div class="tab" onclick="switchTab('comparisons')">–ú–æ–∏ —Ä–∞—Å—á–µ—Ç—ã</div>
                <div class="tab" onclick="switchTab('stats')">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∞ —Å–±–æ—Ä–æ–∫ -->
            <div class="tab-content active" id="buildsTab">
                <h2>–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Å–±–æ—Ä–∫–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤</h2>
                <div class="builds-grid" id="buildsGrid">
                    <!-- –°–±–æ—Ä–∫–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </div>
                <div class="empty-state" id="buildsEmpty" style="display: none;">
                    <h3>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Å–±–æ—Ä–æ–∫</h3>
                    <p>–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é —Å–±–æ—Ä–∫—É –≤ —Ä–∞–∑–¥–µ–ª–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤</p>
                    <a href="artifacts.html" class="calculate-button" style="display: inline-block; width: auto; margin-top: 1rem;">
                        –ü–µ—Ä–µ–π—Ç–∏ –∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞–º
                    </a>
                </div>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∞ —Ä–∞—Å—á–µ—Ç–æ–≤ -->
            <div class="tab-content" id="comparisonsTab">
                <h2>–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ä–∞—Å—á–µ—Ç—ã —É—Ä–æ–Ω–∞</h2>
                <div class="comparisons-grid" id="comparisonsGrid">
                    <!-- –†–∞—Å—á–µ—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </div>
                <div class="empty-state" id="comparisonsEmpty" style="display: none;">
                    <h3>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ä–∞—Å—á–µ—Ç–æ–≤</h3>
                    <p>–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π –ø–µ—Ä–≤—ã–π —Ä–∞—Å—á–µ—Ç –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ —É—Ä–æ–Ω–∞</p>
                    <a href="damage-calculator.html" class="calculate-button" style="display: inline-block; width: auto; margin-top: 1rem;">
                        –ü–µ—Ä–µ–π—Ç–∏ –∫ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—É
                    </a>
                </div>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
            <div class="tab-content" id="statsTab">
                <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</h2>
                <div class="stats-grid" id="statsGrid">
                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
                </div>
                <div class="empty-state" id="statsEmpty">
                    <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</h3>
                </div>
            </div>
        </div>
    </div>

    <script src="auth.js"></script>
    <script>
        let currentTab = 'builds';

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            if (!authSystem.checkAuth()) {
                alert('–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
                window.location.href = 'index.html';
                return;
            }

            console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', authSystem.getUserInfo());
            await loadSavedBuilds();
        });

        function switchTab(tabName) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.getElementById(tabName + 'Tab').classList.add('active');
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            currentTab = tabName;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
            if (tabName === 'builds') {
                loadSavedBuilds();
            } else if (tabName === 'comparisons') {
                loadSavedComparisons();
            } else if (tabName === 'stats') {
                loadUserStats();
            }
        }

        async function loadSavedBuilds() {
            try {
                console.log('üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–±–æ—Ä–æ–∫...');
                
                const response = await fetch('http://localhost:3000/api/builds/user', {
                    headers: authSystem.getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const builds = await response.json();
                const buildsGrid = document.getElementById('buildsGrid');
                const emptyState = document.getElementById('buildsEmpty');

                console.log('üì¶ –ü–æ–ª—É—á–µ–Ω–æ —Å–±–æ—Ä–æ–∫:', builds);

                if (!builds || builds.length === 0) {
                    buildsGrid.style.display = 'none';
                    emptyState.style.display = 'block';
                    return;
                }

                buildsGrid.innerHTML = builds.map(build => `
                    <div class="build-card">
                        <div class="card-actions">
                            <button class="action-btn" onclick="loadBuild(${build.id})" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å">üìÇ</button>
                            <button class="action-btn" onclick="deleteBuild(${build.id})" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                        </div>
                        <h3>${build.build_name}</h3>
                        <p>–ö–æ—Å—Ç—é–º: ${build.weapon_data?.suit || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                        <p>–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä: ${build.weapon_data?.container || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                        <p>–ê—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤: ${build.weapon_data?.artifacts?.length || 0}</p>
                        <small>–°–æ–∑–¥–∞–Ω–æ: ${new Date(build.created_at).toLocaleDateString()}</small>
                    </div>
                `).join('');
                
                buildsGrid.style.display = 'grid';
                emptyState.style.display = 'none';
            } catch (error) {
                console.error('‚ùå Error loading builds:', error);
                document.getElementById('buildsEmpty').innerHTML = `
                    <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
                    <p>${error.message}</p>
                    <a href="index.html" class="calculate-button" style="display: inline-block; width: auto; margin-top: 1rem;">
                        –ù–∞ –≥–ª–∞–≤–Ω—É—é
                    </a>
                `;
                document.getElementById('buildsEmpty').style.display = 'block';
            }
        }

        async function loadSavedComparisons() {
            try {
                console.log('üìä –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏–π...');
                
                const response = await fetch('http://localhost:3000/api/comparisons/user', {
                    headers: authSystem.getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const comparisons = await response.json();
                const comparisonsGrid = document.getElementById('comparisonsGrid');
                const emptyState = document.getElementById('comparisonsEmpty');

                console.log('üìä –ü–æ–ª—É—á–µ–Ω–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏–π:', comparisons);

                if (!comparisons || comparisons.length === 0) {
                    comparisonsGrid.style.display = 'none';
                    emptyState.style.display = 'block';
                    emptyState.innerHTML = `
                        <h3>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Å—Ä–∞–≤–Ω–µ–Ω–∏–π</h3>
                        <p>–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–µ –ø–µ—Ä–≤–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –æ—Ä—É–∂–∏—è</p>
                        <a href="comparison.html" class="calculate-button" style="display: inline-block; width: auto; margin-top: 1rem;">
                            –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é
                        </a>
                    `;
                    return;
                }

                comparisonsGrid.innerHTML = comparisons.map(comp => `
                    <div class="comparison-card">
                        <div class="card-actions">
                            <button class="action-btn" onclick="deleteComparison(${comp.id})" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                        </div>
                        <h3>${comp.comparison_name}</h3>
                        <p>–û—Ä—É–∂–∏–µ 1: ${comp.weapon1_id}</p>
                        <p>–û—Ä—É–∂–∏–µ 2: ${comp.weapon2_id}</p>
                        <small>–°–æ–∑–¥–∞–Ω–æ: ${new Date(comp.created_at).toLocaleDateString()}</small>
                    </div>
                `).join('');
                
                comparisonsGrid.style.display = 'grid';
                emptyState.style.display = 'none';
            } catch (error) {
                console.error('Error loading comparisons:', error);
                document.getElementById('comparisonsEmpty').innerHTML = `
                    <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–π</h3>
                    <p>${error.message}</p>
                `;
                document.getElementById('comparisonsEmpty').style.display = 'block';
            }
        }

        async function loadUserStats() {
            try {
                const response = await fetch('http://localhost:3000/api/stats', {
                    headers: authSystem.getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const stats = await response.json();
                const statsGrid = document.getElementById('statsGrid');

                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${stats.builds_count || 0}</div>
                        <div>–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Å–±–æ—Ä–æ–∫</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.comparisons_count || 0}</div>
                        <div>–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Å—Ä–∞–≤–Ω–µ–Ω–∏–π</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.users_count || 1}</div>
                        <div>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Å–∏—Å—Ç–µ–º–µ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${Math.round(stats.server_uptime || 0)}—Å</div>
                        <div>–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–µ—Ä–∞</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${authSystem.getUserInfo()?.username || '–ì–æ—Å—Ç—å'}</div>
                        <div>–í–∞—à username</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('statsGrid').innerHTML = `
                    <div class="empty-state">
                        <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        async function deleteBuild(buildId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å–±–æ—Ä–∫—É?')) return;

            try {
                const response = await fetch(`http://localhost:3000/api/builds/${buildId}`, {
                    method: 'DELETE',
                    headers: authSystem.getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }

                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ –°–±–æ—Ä–∫–∞ —É–¥–∞–ª–µ–Ω–∞!');
                    await loadSavedBuilds();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting build:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–±–æ—Ä–∫–∏: ' + error.message);
            }
        }

        async function deleteComparison(comparisonId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ?')) return;

            try {
                // –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞ - –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç —É–¥–∞–ª–µ–Ω–∏—è —Å—Ä–∞–≤–Ω–µ–Ω–∏–π
                alert('–§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Å—Ä–∞–≤–Ω–µ–Ω–∏–π –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏');
            } catch (error) {
                console.error('Error deleting comparison:', error);
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è');
            }
        }

        function loadBuild(buildId) {
            // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º
            window.location.href = `artifacts.html?load=${buildId}`;
        }
    </script>
</body>
</html>