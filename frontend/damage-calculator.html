<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —É—Ä–æ–Ω–∞ - CSX</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .calculator-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 1200px) {
            .calculator-grid {
                grid-template-columns: 1fr;
            }
        }

        .auth-section {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .auth-button {
            background: #4cc9f0;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        .auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
        }

        .auth-form {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2a2a2a;
            padding: 2rem;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
        }

        .save-comparison-btn {
            background: linear-gradient(145deg, #f72585, #b5179e);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 1rem;
        }

        .save-comparison-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div class="auth-modal" id="authModal">
        <div class="auth-form">
            <h3 style="color: #4cc9f0; margin-bottom: 1rem;">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
            <div class="form-group">
                <label style="color: #4cc9f0;">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
                <input type="text" id="loginUsername" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 5px; background: #3a3a3a; color: white;">
            </div>
            <div class="form-group">
                <label style="color: #4cc9f0;">–ü–∞—Ä–æ–ª—å:</label>
                <input type="password" id="loginPassword" style="width: 100%; padding: 10px; border: 1px solid #555; border-radius: 5px; background: #3a3a3a; color: white;">
            </div>
            <button onclick="login()" class="auth-button" style="width: 100%;">–í–æ–π—Ç–∏</button>
            <p id="loginError" style="color: #f72585; margin-top: 1rem; display: none;"></p>
        </div>
    </div>

    <!-- –°–µ–∫—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div class="auth-section">
        <button class="auth-button" onclick="showAuthModal()" id="authBtn">–í–æ–π—Ç–∏</button>
        <span id="userInfo" style="color: white; display: none; margin-left: 10px;"></span>
    </div>

    <div class="container">
        <header>
            <h1>‚öîÔ∏è –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —É—Ä–æ–Ω–∞ CSX</h1>
            <p>–†–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø–∞–¥–∞–Ω–∏–π –∏ –≤—Ä–µ–º—è –¥–ª—è —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è —Ü–µ–ª–∏</p>
        </header>

        <div class="calculator-container">
            <a href="index.html" class="back-button">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>

            <div class="calculator-grid">
                <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö -->
                <div class="input-section">
                    <h2>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ü–µ–ª–∏</h2>
                    
                    <div class="form-group">
                        <label for="health">–ó–¥–æ—Ä–æ–≤—å–µ —Ü–µ–ª–∏ (HP):</label>
                        <input type="number" id="health" min="1" max="1000" value="100">
                    </div>

                    <div class="form-group">
                        <label for="armor">–ë—Ä–æ–Ω—è —Ü–µ–ª–∏ (% –∑–∞—â–∏—Ç—ã):</label>
                        <input type="number" id="armor" min="0" max="95" value="0">
                    </div>

                    <div class="form-group">
                        <label for="distance">–î–∏—Å—Ç–∞–Ω—Ü–∏—è (–º–µ—Ç—Ä—ã):</label>
                        <input type="number" id="distance" min="1" max="1000" value="50">
                    </div>

                    <h2>–í—ã–±–æ—Ä –æ—Ä—É–∂–∏—è</h2>
                    
                    <div class="form-group">
                        <label for="weapon">–û—Å–Ω–æ–≤–Ω–æ–µ –æ—Ä—É–∂–∏–µ:</label>
                        <select id="weapon">
                            <option value="pm">–ü–ú (–ü–∏—Å—Ç–æ–ª–µ—Ç –ú–∞–∫–∞—Ä–æ–≤–∞)</option>
                            <option value="aps">–ê–ü–° (–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–∏—Å—Ç–æ–ª–µ—Ç)</option>
                            <option value="fort12">–§–æ—Ä—Ç-12</option>
                            <option value="ak74" selected>–ê–ö-74</option>
                            <option value="ak74u">–ê–ö–°-74–£</option>
                            <option value="l85">L85A1</option>
                            <option value="groza">–ì—Ä–æ–∑–∞</option>
                            <option value="svd">–°–í–î</option>
                            <option value="vss">–í–°–° –í–∏–Ω—Ç–æ—Ä–µ–∑</option>
                            <option value="svu">–°–í–£-–ê</option>
                            <option value="shotgun">–î—Ä–æ–±–æ–≤–∏–∫</option>
                            <option value="spas12">SPAS-12</option>
                            <option value="mp5">MP5</option>
                            <option value="pkm">–ü–ö–ú</option>
                            <option value="rpg7">–†–ü–ì-7</option>
                            <option value="gauss">–ì–∞—É—Å—Å-–ø—É—à–∫–∞</option>
                            <option value="custom">–°–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ...</option>
                        </select>
                    </div>

                    <div class="form-group" id="customDamageGroup" style="display: none;">
                        <label for="customDamage">–°–≤–æ–π —É—Ä–æ–Ω –æ—Ä—É–∂–∏—è:</label>
                        <input type="number" id="customDamage" min="1" max="500" value="50">
                    </div>

                    <button class="calculate-button" onclick="calculateDamage()">üéØ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
                    <button class="save-comparison-btn" onclick="saveComparison()" id="saveComparisonBtn" disabled>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—á–µ—Ç</button>
                </div>

                <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
                <div class="result-section">
                    <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞</h2>
                    
                    <div class="weapon-info" id="weaponInfo">
                        –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ä—É–∂–∏–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
                    </div>

                    <div class="result-card">
                        <h3>–í–ª–∏—è–Ω–∏–µ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏</h3>
                        <ul class="result-stats">
                            <li id="distanceInfo">‚Äî</li>
                            <li>–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä —É—Ä–æ–Ω–∞: <span id="distanceModifier">‚Äî</span></li>
                        </ul>
                        <div class="damage-bar">
                            <div class="damage-fill" id="distanceBar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="result-card">
                        <h3>–ü–æ–ø–∞–¥–∞–Ω–∏—è –≤ —Ç–µ–ª–æ</h3>
                        <ul class="result-stats">
                            <li id="bodyShots">‚Äî</li>
                            <li>–£—Ä–æ–Ω –∑–∞ –≤—ã—Å—Ç—Ä–µ–ª: <span id="bodyDamage">‚Äî</span></li>
                            <li>–û–±—â–∏–π —É—Ä–æ–Ω: <span id="totalBodyDamage">‚Äî</span></li>
                            <li>–í—Ä–µ–º—è –Ω–∞ —É–±–∏–π—Å—Ç–≤–æ: <span id="bodyTime">‚Äî</span></li>
                        </ul>
                        <div class="damage-bar">
                            <div class="damage-fill" id="bodyDamageBar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="result-card">
                        <h3>–ü–æ–ø–∞–¥–∞–Ω–∏—è –≤ –≥–æ–ª–æ–≤—É <span class="critical">(√ó1.5 —É—Ä–æ–Ω–∞)</span></h3>
                        <ul class="result-stats">
                            <li class="headshot" id="headShots">‚Äî</li>
                            <li class="headshot">–£—Ä–æ–Ω –∑–∞ –≤—ã—Å—Ç—Ä–µ–ª: <span id="headDamage">‚Äî</span></li>
                            <li class="headshot">–û–±—â–∏–π —É—Ä–æ–Ω: <span id="totalHeadDamage">‚Äî</span></li>
                            <li class="headshot">–í—Ä–µ–º—è –Ω–∞ —É–±–∏–π—Å—Ç–≤–æ: <span id="headTime">‚Äî</span></li>
                        </ul>
                        <div class="damage-bar">
                            <div class="damage-fill" id="headDamageBar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="result-card">
                        <h3>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
                        <ul class="result-stats">
                            <li>–í—ã—Å—Ç—Ä–µ–ª–æ–≤ —ç–∫–æ–Ω–æ–º–∏—è: <span id="shotsSaved">‚Äî</span></li>
                            <li>–í—Ä–µ–º–µ–Ω–∏ —ç–∫–æ–Ω–æ–º–∏—è: <span id="timeSaved">‚Äî</span></li>
                            <li>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤ –≥–æ–ª–æ–≤—É: <span id="efficiency">‚Äî</span></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    

    <script src="auth.js"></script>
    <script src="damage-calculator.js"></script>
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        let currentCalculation = null;

        document.addEventListener('DOMContentLoaded', function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            authSystem.checkAuth();
            
            const inputs = document.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('input', calculateDamage);
            });
            
            document.getElementById('weapon').addEventListener('change', function() {
                updateWeaponInfo();
                calculateDamage();
            });
            
            init();
        });

        function showAuthModal() {
            document.getElementById('authModal').style.display = 'block';
        }

        function hideAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            document.getElementById('loginError').style.display = 'none';
        }

        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const errorElement = document.getElementById('loginError');

            try {
                const result = await authSystem.login(username, password);
                hideAuthModal();
                
                document.getElementById('authBtn').style.display = 'none';
                document.getElementById('userInfo').style.display = 'inline';
                document.getElementById('userInfo').textContent = `–ü—Ä–∏–≤–µ—Ç, ${result.user.username}`;
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                document.getElementById('saveComparisonBtn').disabled = false;
                
                alert('–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ä–∞—Å—á–µ—Ç—ã.');
            } catch (error) {
                errorElement.textContent = error.message;
                errorElement.style.display = 'block';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞—Å—á–µ—Ç–∞
        async function saveComparison() {
            if (!authSystem.checkAuth()) {
                alert('–î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞—Å—á–µ—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É');
                showAuthModal();
                return;
            }

            if (!currentCalculation) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ä–∞—Å—á–µ—Ç');
                return;
            }

            const comparisonName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞—Å—á–µ—Ç–∞:');
            if (!comparisonName) return;

            const saveData = {
                comparison_name: comparisonName,
                weapon1_id: currentCalculation.weapon.id,
                parameters: {
                    health: currentCalculation.health,
                    armor: currentCalculation.armor,
                    distance: currentCalculation.distance
                },
                results: currentCalculation.results
            };

            try {
                const response = await fetch('http://localhost:3000/api/comparisons/save', {
                    method: 'POST',
                    headers: authSystem.getAuthHeaders(),
                    body: JSON.stringify(saveData)
                });

                const result = await response.json();

                if (result.success) {
                    alert(`‚úÖ –†–∞—Å—á–µ—Ç "${comparisonName}" —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!`);
                } else {
                    alert(`‚ùå –û—à–∏–±–∫–∞: ${result.error}`);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é calculateDamage –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        const originalCalculateDamage = calculateDamage;
        calculateDamage = function() {
            originalCalculateDamage();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            const health = parseInt(document.getElementById('health').value) || 100;
            const armor = parseInt(document.getElementById('armor').value) || 0;
            const distance = parseInt(document.getElementById('distance').value) || 50;
            const weaponId = document.getElementById('weapon').value;
            
            currentCalculation = {
                weapon: weaponsDB[weaponId],
                health: health,
                armor: armor,
                distance: distance,
                results: {
                    bodyShots: document.getElementById('bodyShots').textContent,
                    headShots: document.getElementById('headShots').textContent,
                    bodyTime: document.getElementById('bodyTime').textContent,
                    headTime: document.getElementById('headTime').textContent
                }
            };
        };
    </script>
</body>
</html>